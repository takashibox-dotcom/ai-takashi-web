# AI Takashi API化 デプロイメント手順書

## 概要

AI TakashiアプリケーションをAPIサーバー + クライアント構成に分離し、軽量化と運用の柔軟性を実現します。

## アーキテクチャ

```
┌─────────────────┐    HTTP/API    ┌─────────────────┐
│   クライアント    │ ◄───────────► │   APIサーバー    │
│                 │                │                 │
│ - UI (PyQt5)    │                │ - FastAPI       │
│ - API通信       │                │ - Gemini API    │
│ - 軽量          │                │ - データ管理     │
└─────────────────┘                └─────────────────┘
```

## ファイル構成

### サーバー側ファイル
- `api_server.py` - FastAPIサーバー
- `text_build.py` - AI応答生成
- `security_utils.py` - セキュリティ管理
- `custom_gpt_manager.py` - キャラクター管理
- `memory_manager.py` - メモリ機能
- `response_time_manager.py` - 応答時間管理
- `setup_server.bat` - サーバーセットアップ
- `run_server.bat` - サーバー起動

### クライアント側ファイル
- `client_ui.py` - クライアントUI
- `client_api.py` - API通信モジュール
- `setup_client.bat` - クライアントセットアップ
- `run_client.bat` - クライアント起動

### 共通ファイル
- `requirements.txt` - 依存関係
- `デプロイメント手順書.md` - このファイル

## セットアップ手順

### 1. サーバー側のセットアップ

#### 1.1 必要なファイルを準備
元のプロジェクトから以下のファイルをコピー：
```
- api_server.py
- text_build.py
- security_utils.py
- custom_gpt_manager.py
- memory_manager.py
- response_time_manager.py
- setup_server.bat
- run_server.bat
- requirements.txt
```

#### 1.2 環境変数の設定
Google APIキーを設定：
```bash
set GOOGLE_API_KEY=your_api_key_here
```

または、`.env`ファイルを作成：
```
GOOGLE_API_KEY=your_api_key_here
```

#### 1.3 セットアップ実行
```bash
setup_server.bat
```

#### 1.4 サーバー起動
```bash
run_server.bat
```

サーバーは `http://localhost:8000` で起動します。

### 2. クライアント側のセットアップ

#### 2.1 必要なファイルを準備
クライアント用の以下のファイルをコピー：
```
- client_ui.py
- client_api.py
- setup_client.bat
- run_client.bat
```

#### 2.2 セットアップ実行
```bash
setup_client.bat
```

#### 2.3 クライアント起動
```bash
run_client.bat
```

## 使用方法

### 基本的な使い方

1. **サーバーを起動**
   ```bash
   run_server.bat
   ```

2. **クライアントを起動**
   ```bash
   run_client.bat
   ```

3. **チャット開始**
   - クライアントUIでメッセージを入力
   - 「送信」ボタンをクリック
   - AIの応答が表示されます

### 高度な機能

#### キャラクター選択
- 左側パネルでキャラクターを選択
- 各キャラクターに応じた応答が生成されます

#### 画像認識
- 「画像を選択」ボタンで画像を選択
- 画像付きでメッセージを送信できます

#### セッション管理
- 「新しいセッション」で新しい会話を開始
- 「チャットクリア」で履歴をクリア

## API仕様

### エンドポイント一覧

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | `/health` | ヘルスチェック |
| POST | `/api/chat` | テキストチャット |
| POST | `/api/chat/image` | 画像付きチャット |
| GET | `/api/sessions` | セッション一覧 |
| GET | `/api/sessions/{id}` | セッション情報 |
| DELETE | `/api/sessions/{id}` | セッション削除 |
| GET | `/api/characters` | キャラクター一覧 |
| GET | `/api/tokens/usage` | トークン使用統計 |
| GET | `/api/memories` | メモリ一覧 |
| POST | `/api/memories` | メモリ作成 |

### リクエスト例

#### テキストチャット
```json
POST /api/chat
{
    "session_id": "session_20241201_143022_1234",
    "message": "こんにちは！",
    "character_id": "character_001"
}
```

#### レスポンス例
```json
{
    "session_id": "session_20241201_143022_1234",
    "response": "こんにちは！何かお手伝いできることはありますか？",
    "tokens_used": 45,
    "response_time": 1.23,
    "timestamp": "2024-12-01T14:30:25"
}
```

## トラブルシューティング

### よくある問題と解決方法

#### 1. サーバーに接続できない
**症状**: クライアントで「サーバー未接続」と表示される

**解決方法**:
- サーバーが起動しているか確認
- ファイアウォールの設定を確認
- ポート8000が使用可能か確認

#### 2. APIキーエラー
**症状**: 「Google APIキーが設定されていません」エラー

**解決方法**:
- 環境変数 `GOOGLE_API_KEY` が設定されているか確認
- APIキーが有効か確認
- `.env`ファイルの形式を確認

#### 3. 依存関係エラー
**症状**: モジュールが見つからないエラー

**解決方法**:
- `setup_server.bat` または `setup_client.bat` を再実行
- 仮想環境が正しくアクティベートされているか確認
- Pythonのバージョンが3.8以上か確認

#### 4. ポートが使用中
**症状**: 「Address already in use」エラー

**解決方法**:
- 他のプロセスがポート8000を使用していないか確認
- `netstat -ano | findstr :8000` でポート使用状況を確認
- 必要に応じて他のポートに変更

## セキュリティ考慮事項

### 本番環境での設定

1. **CORS設定の制限**
   ```python
   # api_server.py の CORS設定を修正
   app.add_middleware(
       CORSMiddleware,
       allow_origins=["http://your-client-domain.com"],  # 特定のドメインのみ許可
       allow_credentials=True,
       allow_methods=["GET", "POST", "DELETE"],
       allow_headers=["*"],
   )
   ```

2. **API認証の追加**
   - APIキー認証の実装
   - レート制限の設定
   - ログイン機能の追加

3. **HTTPS化**
   - SSL証明書の設定
   - セキュアな通信の実現

## パフォーマンス最適化

### サーバー側の最適化

1. **非同期処理の活用**
   ```python
   @app.post("/api/chat")
   async def chat(request: ChatRequest):
       # 非同期処理でパフォーマンス向上
   ```

2. **キャッシュの実装**
   - Redisを使用したセッションキャッシュ
   - レスポンスキャッシュの実装

3. **ロードバランサーの設定**
   - 複数インスタンスでの負荷分散
   - ヘルスチェックの実装

### クライアント側の最適化

1. **接続プールの使用**
   ```python
   # client_api.py で接続プールを設定
   self.session = requests.Session()
   ```

2. **リトライ機能の実装**
   - 自動リトライ機能
   - 指数バックオフ

## 監視とログ

### ログ設定

1. **サーバー側ログ**
   ```python
   # api_server.log にログを出力
   logging.basicConfig(
       level=logging.INFO,
       format='%(asctime)s - %(levelname)s - %(message)s',
       handlers=[
           logging.FileHandler('api_server.log'),
           logging.StreamHandler()
       ]
   )
   ```

2. **ログローテーション**
   - ログファイルの自動ローテーション
   - 古いログの自動削除

### 監視項目

- API応答時間
- エラー率
- トークン使用量
- サーバーリソース使用率

## 今後の拡張予定

### 機能拡張

1. **ユーザー管理機能**
   - ユーザー登録・認証
   - 個人設定の保存

2. **ファイル管理機能**
   - ファイルアップロード・ダウンロード
   - ファイル共有機能

3. **通知機能**
   - WebSocketを使用したリアルタイム通知
   - メール通知機能

### 技術的改善

1. **マイクロサービス化**
   - 機能別のサービス分割
   - コンテナ化（Docker）

2. **データベース導入**
   - PostgreSQL/MySQLでの永続化
   - データのバックアップ・復旧

3. **CI/CDパイプライン**
   - 自動テスト
   - 自動デプロイ

## サポート

### ドキュメント
- API仕様書: `http://localhost:8000/docs`
- スキーマ情報: `http://localhost:8000/redoc`

### ログファイル
- サーバーログ: `api_server.log`
- クライアントログ: コンソール出力

### 連絡先
問題が発生した場合は、ログファイルと共にエラー内容をお知らせください。
