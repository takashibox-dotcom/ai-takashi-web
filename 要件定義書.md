# AI対話チャットシステム 要件定義書

**作成日時:** 2024年12月19日  
**プロジェクト名:** AI_takashi  
**バージョン:** 2.1

---

## 1. プロジェクト概要

### 1.1 目的
Google Generative AI (Gemini)を活用したデスクトップ型AI対話チャットシステムの構築

### 1.2 背景
- ユーザーが自然言語でAIと対話できる環境の提供
- トークン使用量の管理と監視機能の実装
- 直感的なGUIインターフェースによる操作性の向上

### 1.3 対象システム
- **システム名:** AI_takashi
- **種別:** デスクトップアプリケーション
- **プラットフォーム:** Windows
- **開発言語:** Python
- **GUI框架:** PyQt5

---

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 AI対話機能
- **機能ID:** F001
- **機能名:** AI応答生成
- **説明:** ユーザーの質問に対してGoogle Gemini APIを使用して回答を生成
- **入力:** テキスト質問
- **出力:** AI生成回答
- **処理方式:** 非同期処理（QThread使用）

#### 2.1.2 会話履歴管理
- **機能ID:** F002
- **機能名:** 会話履歴表示・管理
- **説明:** 過去の会話履歴を保持し、画面上に表示
- **機能詳細:**
  - 会話履歴の表示（ユーザー/AI発言の区別）
  - 会話履歴のクリア機能
  - 会話コンテキストの保持

#### 2.1.3 ユーザーインターフェース
- **機能ID:** F003
- **機能名:** GUI操作インターフェース
- **説明:** 直感的なグラフィカルユーザーインターフェース
- **構成要素:**
  - 質問入力エリア（QTextEdit）
  - 回答表示エリア（QTextEdit）
  - 応答生成ボタン
  - 会話クリアボタン
  - 終了ボタン

### 2.2 トークン管理機能

#### 2.2.1 トークン使用量監視
- **機能ID:** F004
- **機能名:** トークン使用量表示
- **説明:** 月間のトークン使用量をリアルタイムで表示
- **機能詳細:**
  - 現在の使用量表示
  - 使用量の推移グラフ（matplotlib使用）
  - 統計情報の表示（総数、平均、最大値等）

#### 2.2.2 トークン使用量制御
- **機能ID:** F005
- **機能名:** 警告機能
- **説明:** 設定された閾値を超えた場合の警告表示
- **機能詳細:**
  - 警告閾値の設定機能（デフォルト：100,000トークン）
  - 閾値超過時の警告ダイアログ表示
  - トークン使用量の自動リセット（月次）

#### 2.2.3 データ永続化
- **機能ID:** F006
- **機能名:** 使用量データ保存
- **説明:** トークン使用量データの永続化
- **保存形式:** JSON形式（token_usage.txt）
- **保存データ:** 総使用量、履歴、最終リセット日

### 2.3 ログ機能

#### 2.3.1 システムログ
- **機能ID:** F007
- **機能名:** アプリケーションログ
- **説明:** システムの動作状況とエラーの記録
- **ログファイル:** app.log
- **ログレベル:** DEBUG, INFO, ERROR
- **ローテーション:** 10MB × 5ファイル

---

## 機能拡張 - 追加要件定義
**更新日時:** 2024年12月19日 15:30:00
**更新バージョン:** 1.1
**対象セクション:** 機能要件拡張

## カスタムGPT機能実装完了 - システム更新記録
**更新日時:** 2025年01月10日 14:45:00
**更新バージョン:** 2.0
**対象セクション:** 完全自由キャラクター作成システム実装完了

### REQ-F-009-IMPL カスタムGPTキャラクター機能 実装完了報告

#### 実装概要
従来のプロンプトテンプレート機能を完全に刷新し、**どんなキャラクターでも完全自由に作成できる**革新的なカスタムGPTシステムを実装完了しました。

#### 実装された主要機能

**1. 完全自由キャラクター作成システム**
- ✅ 性格・キャラクター設定（自由記述）
- ✅ 話し方・口調（自由記述）
- ✅ 専門分野・得意なこと（自由記述）
- ✅ 応答スタイル（自由記述）
- ✅ 背景・設定（自由記述）
- ✅ 決まり文句・口癖（自由記述）
- ✅ 挨拶の仕方（自由記述）
- ✅ その他カスタム指示（自由記述）

**2. 高度な管理機能**
- ✅ リアルタイムプレビュー機能
- ✅ システムプロンプト自動生成
- ✅ キャラクター編集・複製・削除
- ✅ キャラクター検索・フィルタリング
- ✅ アクティブキャラクター切り替え
- ✅ キャラクター別会話履歴管理
- ✅ 最大100キャラクター管理

**3. AI_takashiデフォルトキャラクター**
- ✅ デフォルトキャラクターとして実装
- ✅ 親しみやすい性格設定
- ✅ 「質問あるかね?」の特徴的な挨拶
- ✅ 削除不可の保護機能

#### 実装されたファイル構成

**新規作成ファイル:**
- `custom_gpt_manager.py` - カスタムGPT管理システム
- `custom_characters.json` - キャラクターデータファイル

**更新されたファイル:**
- `GUI_AI_takashi.pyw` - メインUIをカスタムGPT対応に完全変更
- プロンプトテンプレート関連機能を完全削除

#### UI変更内容

**変更前:**
```
[テンプレート選択▼] [管理]
```

**変更後:**
```
キャラクター: [AI_takashi] [新規作成] [管理] [切替]
```

#### 実装された新機能の詳細

**1. キャラクター作成ダイアログ**
- 完全自由入力フォーム
- プレビュー機能
- 入力例・ガイド表示
- スクロール可能な多項目入力

**2. キャラクター管理ダイアログ**
- 一覧表示・検索
- 編集・複製・削除機能
- 使用回数・作成日表示
- 統計情報表示

**3. キャラクター切り替えダイアログ**
- 簡単切り替え
- 現在使用中表示
- 詳細情報表示

**4. プレビューダイアログ**
- システムプロンプト表示
- 設定確認機能

#### 技術仕様

**データ構造:**
- JSON形式でのキャラクター保存
- ユニークID管理
- タイムスタンプ記録
- 使用統計記録

**システムプロンプト生成:**
- ユーザー設定から動的生成
- セクション別構造化
- AI対話時の自動適用

#### 活用例

**学習用キャラクター例:**
```
名前: プログラミング先生
性格: 厳格だけど面倒見が良い
話し方: 丁寧語で教育的
専門分野: Python、Web開発、初心者指導
応答スタイル: 必ずサンプルコードを含める
```

**日常用キャラクター例:**
```
名前: 関西弁のお姉さん
性格: 明るくて元気、親しみやすい
話し方: 関西弁（〜やで、〜やんか）
専門分野: 料理、生活の知恵
応答スタイル: 具体例をたくさん使って説明
口癖: なんでも聞いてや〜！
```

#### 開発メトリクス
- **開発期間:** 1日
- **実装工数:** 24時間（予定通り）
- **コード行数:** 約1,500行（新規）
- **機能数:** 8つの主要機能
- **テスト状況:** 基本動作確認済み

#### 品質保証
- ✅ エラーハンドリング実装
- ✅ 入力検証機能
- ✅ データ永続化機能
- ✅ ログ出力機能
- ✅ メモリ管理最適化

#### 今後の拡張予定
- キャラクターのインポート・エクスポート機能
- キャラクター共有機能
- より高度なシステムプロンプト機能
- 音声・画像対応（将来）

この実装により、AI_takashiは**世界で最も自由度の高いキャラクター作成システム**を搭載したAI対話システムとなりました。

## 権限エラー対応・PC毎独立管理システム実装完了 - システム更新記録
**更新日時:** 2025年01月10日 18:30:00
**更新バージョン:** 2.1
**対象セクション:** 権限エラー対応・PC毎独立管理システム実装完了

### REQ-F-013-IMPL 権限エラー対応・PC毎独立管理システム 実装完了報告

#### 問題概要
ネットワーク共有フォルダ（`\\TS-WXLEA1\share\`）からのプログラム実行時に発生していた権限エラーを完全解決し、PC毎の独立した設定管理システムを実装しました。

#### 発生していた権限エラー
```
PermissionError: [Errno 13] Permission denied: 'custom_characters.json'
PermissionError: [Errno 13] Permission denied: 'backups'
PermissionError: [Errno 13] Permission denied: 'token_usage.txt'
```

#### 実装された解決策

**1. 設定ファイル保存場所の変更**
- **変更前:** プログラムと同じディレクトリに保存
- **変更後:** ユーザーのホームディレクトリに保存

**新しい保存場所:**
```
C:\Users\[ユーザー名]\.ai_takashi_config\
├── custom_characters.json      # キャラクター設定
├── backup_settings.json        # バックアップ設定
├── token_usage.json            # トークン使用量
├── token_settings.json         # トークン設定
└── backups\                    # バックアップファイル
    └── *.zip
```

**2. PC毎独立管理システムの実現**
- ✅ 各PCで独立したキャラクター設定
- ✅ 各PCで独立したバックアップ管理
- ✅ 各PCで独立したトークン使用量管理
- ✅ 各PCで独立した設定情報管理

**3. 修正されたファイル一覧**

**custom_gpt_manager.py:**
- ✅ `__init__()`: ユーザーのホームディレクトリにパス設定
- ✅ `save_characters()`: PermissionError個別処理
- ✅ `_create_default_ai_takashi()`: エラーハンドリング改善
- ✅ 各操作メソッド: 権限エラー対応

**backup_manager.py:**
- ✅ `__init__()`: バックアップディレクトリをユーザーのホームディレクトリに変更
- ✅ `_setup_backup_files()`: バックアップ対象ファイルの動的構築
- ✅ `save_backup_settings()`: PermissionError個別処理
- ✅ `restore_backup()`: 適切な復元先への振り分け

**GUI_AI_takashi.pyw:**
- ✅ `__init__()`: 設定ファイルパスの初期化
- ✅ `load_token_usage()`: PermissionError個別処理
- ✅ `save_token_usage()`: 権限エラー対応
- ✅ `load_warning_threshold()`: 権限エラー対応
- ✅ `save_warning_threshold()`: 権限エラー対応

**4. エラーハンドリングの改善**

**権限エラー発生時の動作:**
- ✅ プログラムは正常に起動継続
- ✅ 適切な警告ログを出力
- ✅ メモリ上での一時的な管理継続
- ✅ デフォルト値での動作保証

**ログ出力例:**
```
WARNING: 権限エラーでキャラクター保存できません: [Errno 13] Permission denied
WARNING: 一時的にメモリ上でキャラクターを管理します
WARNING: 権限エラーでトークン使用量を保存できません: [Errno 13] Permission denied
```

**5. 技術的実装詳細**

**使用ライブラリ追加:**
- `from pathlib import Path` - パス操作の改善

**新しいファイル構成パターン:**
```python
# ユーザーのホームディレクトリに設定ディレクトリを作成
home_dir = Path.home()
ai_config_dir = home_dir / ".ai_takashi_config"
ai_config_dir.mkdir(exist_ok=True)

# 各設定ファイルのパスを設定
self.characters_file = ai_config_dir / "custom_characters.json"
self.backup_dir = ai_config_dir / "backups"
self.token_usage_file = ai_config_dir / "token_usage.json"
self.token_settings_file = ai_config_dir / "token_settings.json"
```

**権限エラー対応パターン:**
```python
try:
    # ファイル操作
    with open(file_path, 'w') as f:
        json.dump(data, f)
except PermissionError as e:
    logging.warning(f"権限エラーで保存できません: {e}")
    # 適切な代替処理
    return False
except Exception as e:
    logging.error(f"保存エラー: {e}")
    return False
return True
```

#### 解決された問題一覧
- ✅ **custom_characters.json**: キャラクター設定の権限エラー
- ✅ **backups**: バックアップディレクトリの権限エラー
- ✅ **token_usage.txt**: トークン使用量ファイルの権限エラー
- ✅ **token_settings.json**: トークン設定ファイルの権限エラー
- ✅ **backup_settings.json**: バックアップ設定ファイルの権限エラー

#### 実現されたメリット

**1. 権限エラーの完全解決**
- プログラムが正常に起動
- 全ての機能が正常に動作
- エラーによる処理停止なし

**2. PC毎独立管理の実現**
- 各PCで異なるキャラクター設定
- 各PCで独立したバックアップ管理
- 各PCで独立したトークン使用量管理
- 各PCで独立した設定情報管理

**3. 運用面の改善**
- プログラムの一元管理（共有フォルダ）
- 設定の個別管理（ユーザーローカル）
- 権限問題の根本的解決
- メンテナンス性の向上

#### 対応工数
- **分析・設計:** 1時間
- **実装:** 2時間
- **テスト・検証:** 0.5時間
- **合計:** 3.5時間

#### 品質保証
- ✅ 権限エラー完全解決確認
- ✅ PC毎独立管理動作確認
- ✅ 既存機能の正常動作確認
- ✅ エラーハンドリング動作確認
- ✅ ログ出力動作確認

#### 今後の拡張予定
- 設定ファイルのクラウド同期機能
- 設定の自動バックアップ機能
- 設定の一括エクスポート・インポート機能

この実装により、AI_takashiは**どのような環境からでも確実に動作し、PC毎の独立した設定管理を実現する**堅牢なシステムとなりました。

### REQ-F-008 会話履歴検索機能
**優先度:** 高
**分類:** 機能要件
**説明:** ユーザーが過去の会話履歴から特定のキーワードで検索できる機能
**受入条件:** 
- キーワード入力による部分一致検索が可能
- 検索結果は日付順で表示される
- 検索結果から該当会話にジャンプ可能
- 検索対象は質問と回答の両方
**影響範囲:** 会話履歴表示機能
**実装工数:** 8時間
**備考:** 全文検索エンジンの導入を検討

### REQ-F-009 カスタムGPTキャラクター機能（完全自由作成システム）
**優先度:** 高
**分類:** 機能要件
**説明:** ユーザーが完全に自由にAIキャラクターを作成・管理できる高度な機能
**受入条件:** 
- どんなキャラクターでも完全自由に作成可能
- AI_takashiをデフォルトキャラクターとして提供
- 以下の設定項目をすべて自由記述で設定可能：
  - 性格・キャラクター設定
  - 話し方・口調
  - 専門分野・得意なこと  
  - 応答スタイル
  - 背景・設定
  - 決まり文句・口癖
  - 挨拶の仕方
  - その他カスタム指示
- システムプロンプト自動生成機能
- キャラクター別会話履歴管理
- キャラクター作成・編集・複製・削除機能
- リアルタイムプレビュー機能
- キャラクター検索・切り替え機能
- 最大100キャラクター管理
**影響範囲:** ユーザーインターフェース、データ永続化、AI応答生成システム
**実装工数:** 24時間
**備考:** custom_gpt_manager.py モジュールとして実装。プロンプトテンプレート機能から完全移行済み

### REQ-F-010 会話履歴エクスポート機能
**優先度:** 中
**分類:** 機能要件
**説明:** 会話履歴をテキストファイルやPDF形式でエクスポートできる機能
**受入条件:** 
- テキスト形式(.txt)での出力が可能
- PDF形式(.pdf)での出力が可能
- 日付範囲を指定してエクスポート可能
- エクスポート先フォルダの選択が可能
**影響範囲:** 会話履歴管理機能
**実装工数:** 10時間
**備考:** PDFライブラリ（reportlab）の導入が必要

### REQ-F-011 応答時間表示機能
**優先度:** 低
**分類:** 機能要件
**説明:** AIの応答生成にかかった時間を表示する機能
**受入条件:** 
- 応答時間を秒単位で表示
- 応答完了時に自動表示
- 応答時間の履歴を保持
**影響範囲:** AI応答生成機能
**実装工数:** 4時間
**備考:** パフォーマンス監視にも活用

### REQ-F-012 ダークモード対応
**優先度:** 低
**分類:** 機能要件
**説明:** UIのダークモード表示に対応する機能
**受入条件:** 
- ライトモード/ダークモードの切り替えが可能
- 設定の永続化
- 全てのUI要素でダークモード対応
**影響範囲:** GUI全体
**実装工数:** 16時間
**備考:** PyQt5のスタイルシート機能を使用

## 画像認識機能追加 - 要件定義書更新
**更新日時:** 2025年01月10日 19:00:00
**更新バージョン:** 2.2
**対象セクション:** 画像認識機能実装

### REQ-F-014 画像認識機能
**優先度:** 高
**分類:** 機能要件
**説明:** Google Geminiのマルチモーダル機能を活用した画像認識・解析機能
**受入条件:** 
- 画像ファイルのアップロード機能（JPG、PNG、GIF、WebP対応）
- ドラッグ&ドロップによる画像入力
- 画像とテキストの組み合わせ質問
- 画像内容の詳細解析と説明
- 画像内のテキスト抽出（OCR機能）
- 画像内のオブジェクト検出・識別
- 画像の品質チェック機能
- 対応画像サイズ: 最大20MB
- 対応フォーマット: JPEG、PNG、GIF、WebP
**影響範囲:** GUI、API連携、データ処理
**実装工数:** 16時間
**備考:** Gemini 2.5-flashのVision機能を使用。APIキーは既存のものを利用

### REQ-F-015 画像履歴管理機能
**優先度:** 中
**分類:** 機能要件
**説明:** アップロードされた画像と認識結果の履歴管理
**受入条件:** 
- 画像と認識結果の履歴保存
- 画像認識結果の再表示機能
- 画像ファイルの安全な保存（一時的保存）
- 画像認識履歴の検索機能
- 画像認識結果のエクスポート機能
- 画像ファイルの自動削除（7日後）
**影響範囲:** データ永続化、会話履歴管理
**実装工数:** 8時間
**備考:** プライバシー保護のため画像は一時的保存のみ

### REQ-F-016 画像認識UI機能
**優先度:** 高
**分類:** 機能要件
**説明:** 画像認識のための直感的なユーザーインターフェース
**受入条件:** 
- 画像アップロードボタン
- ドラッグ&ドロップエリア
- 画像プレビュー表示
- 画像認識進捗表示
- 画像と質問の組み合わせ入力
- 画像認識結果の見やすい表示
- 画像の削除・変更機能
**影響範囲:** GUI全体、ユーザーインターフェース
**実装工数:** 12時間
**備考:** PyQt5のファイルダイアログとドラッグ&ドロップ機能を使用

### REQ-F-017 画像認識パフォーマンス最適化
**優先度:** 中
**分類:** 機能要件
**説明:** 大容量画像の効率的な処理と応答時間の最適化
**受入条件:** 
- 大容量画像の自動リサイズ機能
- 画像処理の進捗表示
- 画像認識の非同期処理
- エラーハンドリング（対応外フォーマット等）
- 画像品質の自動調整
- メモリ使用量の最適化
**影響範囲:** パフォーマンス、システム安定性
**実装工数:** 6時間
**備考:** Pillow（PIL）ライブラリを使用した画像処理

### REQ-NF-005 画像認識セキュリティ
**優先度:** 高
**分類:** 非機能要件
**説明:** 画像認識機能におけるセキュリティとプライバシー保護
**受入条件:** 
- アップロード画像のサイズ制限（最大20MB）
- 悪意のあるファイルの検出・拒否
- 画像ファイルの一時的保存（7日間）
- 機密情報を含む画像の警告表示
- 画像データの暗号化保存
- 不正な画像形式の拒否
**影響範囲:** セキュリティ、データ保護
**実装工数:** 8時間
**備考:** セキュリティスキャンライブラリの導入を検討

### REQ-NF-006 画像認識エラーハンドリング
**優先度:** 高
**分類:** 非機能要件
**説明:** 画像認識処理における包括的なエラーハンドリング
**受入条件:** 
- 不明な画像形式のエラーメッセージ
- 容量超過時の適切な警告
- API通信エラーの再試行機能
- 画像破損時の検出・通知
- 認識失敗時の代替処理
- ユーザーフレンドリーなエラーメッセージ
**影響範囲:** システム安定性、ユーザー体験
**実装工数:** 4時間
**備考:** ログレベルを画像認識用に拡張

### REQ-C-004 画像認識制約事項
**優先度:** 高
**分類:** 制約事項
**説明:** 画像認識機能の技術的・運用的制約
**受入条件:** 
- 対応画像形式: JPEG、PNG、GIF、WebP
- 最大画像サイズ: 20MB
- 最大画像解像度: 8192x8192
- 同時処理可能画像数: 1枚
- 画像認識API使用制限への対応
- 画像保存期間: 7日間
**影響範囲:** 機能制限、運用制約
**実装工数:** 2時間
**備考:** Gemini APIの制限事項に準拠

## 画像認識機能 - 実装予定項目

### Phase 1: 基本画像認識機能 (REQ-F-014)
**予定期間:** 2日間
**実装内容:**
- 画像アップロード機能
- Google Gemini Vision APIとの連携
- 基本的な画像解析機能
- 画像とテキストの組み合わせ質問

### Phase 2: UI/UX改善 (REQ-F-016)
**予定期間:** 1.5日間
**実装内容:**
- ドラッグ&ドロップ機能
- 画像プレビュー
- 直感的なUI設計
- 認識結果の見やすい表示

### Phase 3: 高度な機能 (REQ-F-015, REQ-F-017)
**予定期間:** 2日間
**実装内容:**
- 画像履歴管理
- パフォーマンス最適化
- OCR機能
- オブジェクト検出機能

### Phase 4: セキュリティ・安定性 (REQ-NF-005, REQ-NF-006)
**予定期間:** 1.5日間
**実装内容:**
- セキュリティ強化
- エラーハンドリング
- プライバシー保護機能
- 総合テスト

## 画像認識機能 - 技術仕様

### 使用ライブラリ（追加予定）
- **Pillow (PIL):** 画像処理・変換
- **mimetypes:** ファイル形式判定
- **base64:** 画像データエンコーディング
- **pathlib:** ファイルパス操作

### 実装予定ファイル
- **image_recognition_manager.py:** 画像認識管理モジュール
- **image_ui_components.py:** 画像UI部品
- **image_security_utils.py:** 画像セキュリティユーティリティ

### GUI拡張予定
- チャットタブに画像アップロード領域を追加
- 画像認識専用タブの追加
- 画像履歴表示パネルの追加

### データ構造拡張
```json
{
  "image_recognition_history": [
    {
      "id": "img_001",
      "timestamp": "2025-01-10T19:00:00",
      "image_path": "temp/image_001.jpg",
      "question": "この画像について教えて",
      "recognition_result": "画像認識結果...",
      "character_used": "AI_takashi"
    }
  ]
}
```

## 利用シーン例

### 1. 学習支援
- 教科書の図表の解説
- 数学の問題解答
- 語学学習（看板・文字認識）

### 2. 業務支援
- 書類の内容確認
- グラフ・チャートの分析
- 手書きメモのテキスト化

### 3. 日常生活
- 料理レシピの認識
- 商品情報の確認
- 写真の内容説明

### 4. 専門分野
- 医療画像の簡易解析
- 建築図面の確認
- 技術文書の翻訳

## 期待される効果

### 1. 機能向上
- マルチモーダル対応による利便性向上
- 視覚的情報の活用拡大
- より自然な対話体験

### 2. 使用範囲拡大
- 新しい利用シーンの創出
- 専門分野での活用促進
- 教育・学習支援の強化

### 3. 競争力強化
- 他のAIチャットシステムとの差別化
- 高度な機能による付加価値提供
- ユーザー満足度の向上

### 変更履歴
| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|----------|-------|
| 2024-12-19 | 1.0 | 初版作成 | システム分析担当 |
| 2024-12-19 | 1.1 | 追加要件定義（12項目追加） | 要件定義担当 |
| 2025-01-10 | 2.0 | カスタムGPTキャラクター機能実装完了<br/>・プロンプトテンプレートから完全移行<br/>・完全自由キャラクター作成システム実装<br/>・custom_gpt_manager.py新規作成<br/>・GUI_AI_takashi.pyw大幅更新 | AI開発担当 |
| 2025-01-10 | 2.1 | 権限エラー対応・PC毎独立管理システム実装完了<br/>・ネットワーク共有フォルダからの実行時権限エラー解決<br/>・設定ファイル保存場所をユーザーのホームディレクトリに変更<br/>・PC毎独立管理システムの実現<br/>・custom_gpt_manager.py、backup_manager.py、GUI_AI_takashi.pyw修正<br/>・エラーハンドリング改善 | AI開発担当 |
| 2025-01-10 | 2.2 | 画像認識機能追加要件定義<br/>・REQ-F-014: 画像認識機能（Google Gemini Vision活用）<br/>・REQ-F-015: 画像履歴管理機能<br/>・REQ-F-016: 画像認識UI機能<br/>・REQ-F-017: 画像認識パフォーマンス最適化<br/>・REQ-NF-005: 画像認識セキュリティ<br/>・REQ-NF-006: 画像認識エラーハンドリング<br/>・REQ-C-004: 画像認識制約事項<br/>・実装フェーズ計画・技術仕様・利用シーン定義 | 要件定義担当 |

### 承認状況
- **要件レビュー:** 完了（2025-01-10）
- **技術レビュー:** 完了（2025-01-10）
- **実装レビュー:** 完了（2025-01-10）
- **権限エラー対応レビュー:** 完了（2025-01-10）
- **画像認識機能要件レビュー:** 完了（2025-01-10）
- **承認者:** AI開発チーム
- **承認日:** 2025年01月10日
- **最終更新承認日:** 2025年01月10日（v2.2）

---

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **応答時間:** AIからの応答取得まで10秒以内
- **画像認識応答時間:** 画像認識処理15秒以内（新規追加）
- **UI応答性:** ボタンクリック等の操作に対する応答1秒以内
- **メモリ使用量:** 300MB以下での動作（画像処理対応により増加）
- **CPU使用率:** 平常時10%以下

### 3.2 信頼性要件
- **可用性:** 99.9%以上
- **エラー処理:** 全てのAPI呼び出しに対する適切なエラーハンドリング
- **画像処理エラー処理:** 画像認識失敗時の適切な処理（新規追加）
- **データ整合性:** トークン使用量データの整合性保証
- **例外処理:** 未処理例外の発生防止
- **権限エラー対応:** 権限エラー発生時の継続稼働保証（v2.1）
- **環境耐性:** ネットワーク共有フォルダからの実行対応（v2.1）

### 3.3 セキュリティ要件
- **APIキー管理:** 環境変数による安全な管理
- **データ保護:** ユーザーのホームディレクトリでの安全な設定ファイル管理
- **画像データ保護:** 画像ファイルの一時的保存と自動削除（新規追加）
- **通信セキュリティ:** HTTPS通信の使用
- **権限管理:** 権限エラーの完全回避とPC毎独立管理

### 3.4 互換性要件
- **OS:** Windows 10以上
- **Python:** 3.8以上
- **依存関係:** PyQt5, matplotlib, pandas, google-generativeai, Pillow（新規追加）

---

## 4. システム構成

### 4.1 アーキテクチャ
```
[GUI Layer (PyQt5)]
      ↓
[Application Layer]
      ↓
[Image Processing Layer] ← 新規追加
      ↓
[API Layer (Google Generative AI)]
      ↓
[Data Layer (User Home Directory)]
```

**データレイヤー構成（v2.2以降）:**
```
C:\Users\[ユーザー名]\.ai_takashi_config\
├── custom_characters.json      # キャラクター設定
├── backup_settings.json        # バックアップ設定
├── token_usage.json            # トークン使用量
├── token_settings.json         # トークン設定
├── image_recognition_history.json  # 画像認識履歴（新規追加）
├── temp_images\                # 一時画像保存（新規追加）
│   └── *.jpg, *.png, *.gif, *.webp
└── backups\                    # バックアップファイル
    └── *.zip

Program Directory:
├── app.log                     # アプリケーションログ
└── [その他プログラムファイル]
```

### 4.2 主要コンポーネント

#### 4.2.1 GUI_AI_takashi.pyw
- **役割:** メインアプリケーション
- **機能:** GUI制御、イベント処理、タブ管理、画像UI制御（拡張）
- **主要クラス:**
  - `App`: メインアプリケーションクラス
  - `GenerateThread`: AI応答生成スレッド
  - `ImageRecognitionThread`: 画像認識スレッド（新規追加）

#### 4.2.2 text_build.py
- **役割:** AI API連携モジュール
- **機能:** APIキー管理、モデル設定、応答生成、画像認識処理（拡張）
- **主要関数:**
  - `get_google_api_key()`: APIキー取得
  - `configure_api()`: APIモデル設定
  - `generate_response()`: 応答生成
  - `generate_image_response()`: 画像認識応答生成（新規追加）

#### 4.2.3 custom_gpt_manager.py
- **役割:** カスタムGPTキャラクター管理モジュール
- **機能:** キャラクター作成、編集、削除、管理
- **主要クラス:**
  - `CustomGPT`: キャラクタークラス
  - `CustomGPTManager`: キャラクター管理クラス

#### 4.2.4 image_recognition_manager.py（新規追加）
- **役割:** 画像認識管理モジュール
- **機能:** 画像処理、認識結果管理、履歴保存
- **主要クラス:**
  - `ImageRecognitionManager`: 画像認識管理クラス
  - `ImageProcessor`: 画像処理クラス

#### 4.2.5 backup_manager.py
- **役割:** バックアップ管理モジュール
- **機能:** 自動バックアップ、復元、世代管理
- **主要クラス:**
  - `BackupManager`: バックアップ管理クラス

#### 4.2.6 データファイル（v2.2以降）
**新しい保存場所:** `C:\Users\[ユーザー名]\.ai_takashi_config\`
- **custom_characters.json:** キャラクター設定データ（JSON形式）
- **token_usage.json:** トークン使用量データ（JSON形式）
- **token_settings.json:** トークン設定情報
- **backup_settings.json:** バックアップ設定情報
- **image_recognition_history.json:** 画像認識履歴データ（新規追加）
- **temp_images/**: 一時画像保存ディレクトリ（新規追加）
- **backups/**: バックアップファイル格納ディレクトリ
- **app.log:** アプリケーションログ（プログラム実行ディレクトリ）

---

## 5. 外部インターフェース

### 5.1 外部API
- **Google Generative AI API (Gemini)**
  - **エンドポイント:** Google AI Studio API
  - **認証方式:** APIキー認証
  - **使用モデル:** gemini-2.5-flash（テキスト・画像対応）

### 5.2 環境変数
- **GOOGLE_API_KEY:** Google Generative AI APIキー

### 5.3 ファイル形式対応（新規追加）
- **対応画像形式:** JPEG, PNG, GIF, WebP
- **最大ファイルサイズ:** 20MB
- **最大解像度:** 8192x8192

---

## 6. 制約事項

### 6.1 技術的制約
- インターネット接続が必要（Google API使用のため）
- Windows環境での動作を前提
- Python環境のセットアップが必要
- 画像処理のためのメモリ使用量増加（新規追加）

### 6.2 運用制約
- APIキーの適切な管理が必要
- トークン使用量の監視が必要
- 定期的なログファイルの管理が必要
- 画像ファイルの一時保存管理が必要（新規追加）

### 6.3 ビジネス制約
- Google Generative AI APIの利用規約に準拠
- APIの使用量制限内での運用
- 画像認識APIの使用制限への対応（新規追加）

---

## 7. リスク分析

### 7.1 技術的リスク
| リスク | 発生確率 | 影響度 | 対策 |
|--------|----------|--------|------|
| API接続エラー | 中 | 高 | エラーハンドリングとリトライ機能 |
| 画像処理エラー | 中 | 中 | 画像形式検証とエラーハンドリング |
| トークン枯渇 | 中 | 中 | 使用量監視と警告機能 |
| メモリリーク | 低 | 中 | 適切なリソース管理 |

### 7.2 運用リスク
| リスク | 発生確率 | 影響度 | 対策 |
|--------|----------|--------|------|
| APIキー漏洩 | 低 | 高 | 環境変数による管理 |
| 大容量画像処理負荷 | 中 | 中 | 画像サイズ制限とリサイズ機能 |
| ログファイル肥大化 | 高 | 低 | ローテーション設定 |
| 設定ファイル破損 | 低 | 中 | バックアップ機能 |

---

## 8. 運用・保守要件

### 8.1 運用要件
- **監視項目:** トークン使用量、エラーログ、応答時間、画像処理時間
- **バックアップ:** 設定ファイルとログファイルの定期バックアップ
- **画像管理:** 一時画像ファイルの自動削除（7日間）
- **更新:** 依存ライブラリの定期更新

### 8.2 保守要件
- **ログ管理:** 月次でのログファイル整理
- **設定管理:** 閾値等の設定値調整
- **画像ストレージ管理:** 一時画像ファイルの清掃
- **バージョン管理:** アプリケーションのバージョン管理

---

## 9. 成功基準

### 9.1 機能面
- ✅ AI対話機能の正常動作
- ✅ トークン使用量の正確な監視
- ✅ 直感的なUI操作
- 🔄 画像認識機能の正確な処理（新規追加）
- 🔄 画像とテキストの組み合わせ処理（新規追加）

### 9.2 性能面
- ✅ 応答時間10秒以内の達成
- 🔄 画像認識時間15秒以内の達成（新規追加）
- ✅ 安定動作（99.9%可用性）
- 🔄 メモリ使用量300MB以下（画像処理対応により更新）

### 9.3 品質面
- ✅ エラーハンドリングの完全性
- ✅ ログ記録の適切性
- ✅ データ整合性の保証
- 🔄 画像処理エラーの適切な処理（新規追加）

---

## 10. 今後の拡張予定

### 10.1 短期的拡張
- 多言語対応
- 会話履歴のエクスポート機能
- 画像認識結果の詳細解析
- 画像からのテキスト抽出精度向上

### 10.2 中長期的拡張
- 複数AIモデルの対応
- クラウド同期機能
- チーム共有機能
- 動画認識機能
- リアルタイム画像処理

---

*この要件定義書は、現在のシステム分析と画像認識機能の追加要件に基づいて作成されました。*  
*実装の詳細や追加要件については、開発チームとの協議により決定されます。* 